<html>

<head>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<meta name="viewport" content="user-scalable=no, width=device-width" />
<script src="javascript/TestWebsiteJS.js"></script>

<script src="jquery-ui-1.8.20.custom/development-bundle/jquery-1.7.2.js"></script>
<script src="jquery-ui-1.8.20.custom/development-bundle/ui/jquery.ui.core.js"></script>
<script src="jquery-ui-1.8.20.custom/development-bundle/ui/jquery.ui.widget.js"></script>
<script src="jquery-ui-1.8.20.custom/development-bundle/ui/jquery.ui.mouse.js"></script>
<script src="jquery-ui-1.8.20.custom/development-bundle/ui/jquery.ui.draggable.js"></script>
<script src="jquery-ui-1.8.20.custom/development-bundle/ui/jquery.ui.droppable.js"></script>
<script src="jquery-ui-1.8.20.custom/development-bundle/ui/jquery.ui.sortable.js"></script>

<script>
var editing = false;

/* This is run when the html is finished loading*/
$(function() {
		$(this).makeDroppable();
});
	
/* If we are currently renaming, then we make an group with the textarea, else if just create regular text*/
$.fn.newGroup = function() {
	if(editing == true) {
		$("#groupList").append("<li class = 'icon group connectedSortable'><img onclick='$(this).test();' class='delete' src='icons/delete.png'></img><div onclick='$(this).hide5();'><textarea>New Group</textarea></div><ul class = 'apple'></ul></li>");
	} else {
		$("#groupList").append("<li class = 'icon group connectedSortable'><div onclick='$(this).hide5();'>New Group</div><ul class = 'apple'></ul></li>");	
	}
	$(this).makeDroppable(); /* Makes new group droppable */
};

/* Converts the name to a textarea to start renaming. Converts text area to text when finished */
$.fn.rename = function() {
	if(editing == false) {
		$("#groupList li").not(".trash").each(function(index) {
			/*Renaming*/
			var name = $(this).find("div").html();
			$(this).find("div").html("<textarea>" + name + "</textarea>");
			
			/*Deleting*/
			var oldHtml = $(this).html();
			$(this).html("<img onclick='$(this).test();' class='delete' src='icons/delete.png'></img>" + oldHtml);
		});
		editing = true;
		$("#renameButton").html("Done");
	} else {
		$("#groupList li").not(".trash").each(function(index) {
			var name = $(this).find("textarea").val();
			if(name == "") {
				name = "New Group";
			}
			$(this).find("div").html(name);		
		});
		
		$(".delete").remove();
		editing = false;
		$("#renameButton").html("Edit");
	}
};

$.fn.test = function() {
	$(this).parent().remove();
};

$.fn.makeDroppable = function() {
		$( "#participantList li" ).draggable({
			helper: "clone",
			cursorAt: { right: 20, top: 20},
			opacity: 0.5,
			handle: "img.dragHandle",
			zIndex: 2700,
		});
		
		/* Everything with the .group class will be droppable, and it'll append it to children with the .apple class */
		$( ".group" ).droppable({
			accept: ":not(.ui-sortable-helper)",
			over: function(event,ui) {$(this).css("color","green");},
			out: function(event,ui) {$(this).css("color", "black");},
			drop: function( event, ui ) {
				$( this ).find(".apple").show(); /* When a new item is added, the group is expanded */
				$( this ).find( ".placeholder" ).remove();
				$( this ).css("color","black");
				
				$( "<li class='icon user'></li>" ).html( ui.draggable.html() ).appendTo( jQuery(".apple",this));
			}
		});
		
				
		/* All groups need .group class and .connectedSortable class to join together for sorting */
		$( ".group" ).sortable({
			items: "li:not(.placeholder)",
			connectWith: ".connectedSortable",
			over: function(event,ui) {
				$(this).css("color","green");},
			out: function(event,ui) {
				$(this).css("color", "black");},
			handle: "img.dragHandle",
			distance: 15,
		});
		
		$( ".trash" ).sortable({
			items: "li:not(.placeholder)",
			connectWith: ".connectedSortable",
			over: function(event,ui) {$(this).css("color","red");},
			out: function(event,ui) {$(this).css("color", "black");},
			distance: 15,
			receive: function(event, ui) {
				$(this).children().not("div").remove();
			}
		});
		
		/* Disabling group sorting for now because it is buggy
		$( "#groupList" ).sortable({
			items: "li:not(.placeholder)",
			distance: 15,
		}).disableSelection();
		*/
};

$.fn.hide5 = function() {

	$(this).next().toggle();
};

</script>

<!-- https://github.com/furf/jquery-ui-touch-punch
Hack to get drag and drop to work on touch devices-->
<script src="javascript/jquery.ui.touch-punch.min.js"></script>

</head>

<body>

<div id="header">
<h1>Participants</h1></div>

<div id="content">

<ul class = "apple" id="participantList">
<li class="user icon"><a href='#'>Byron</a><img class="dragHandle"></li>
<li class="user icon"><a href="mailto:chnewton@hotmail.com">Charles</a><img class="dragHandle"></li>
<li class="user icon"><a href="mailto:chouston@facet.com">Christopher</a><img class="dragHandle"></li>
<li class="user icon"><a href="mailto:sabourid@ucalgary.ca">Daniel</a><img class="dragHandle"></li>
<li class="user icon"><a href="mailto:Dhawkins@facet.com">David</a><img class="dragHandle"></li>
<li class="user icon"><a href="mailto:patrick.f.king@gmail.com">Patrick</a><img class="dragHandle"></li>
<li class="user icon"><a href="mailto:robert.ag.post@gmail.com">Robert</a><img class="dragHandle"></li>
<li class="user icon"><a href="mailto:rmelzer@facet.com">Roseline</a><img class="dragHandle"></li>
<li class="user icon"><a href="mailto:yghanam@gmail.com">Yaser</a><img class="dragHandle"></li>
</ul>
</div>

<h1>Groups</h1>

<div class="leftButton iPhoneButton" onclick="$(this).newGroup();">New</div>
<div class="iPhoneButton" id="renameButton" onclick="$(this).rename();">Edit</div>

<ul class="apple" id = "groupList">
<li class = 'icon trash connectedSortable'>Trash</li>
</ul>

</body>

</html>